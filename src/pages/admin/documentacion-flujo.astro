---
import AdminLayout from "~/layouts/AdminLayout.astro";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";
import { FileText, CreditCard, UserCheck, Users, ChevronDown } from "lucide-react";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  return Astro.redirect("/login");
}

if (!["admin", "registro_control"].includes(user.role)) {
  return Astro.redirect("/admin/dashboard");
}

const stages = [
  {
    id: "stage1",
    numero: "PASO 1",
    title: "Preinscripci√≥n del Estudiante",
    icon: "FileText",
    color: "blue",
    descripcion: "El estudiante completa su informaci√≥n b√°sica para iniciar el proceso",
    queHace: "El estudiante llena un formulario p√∫blico con:",
    pasos: [
      "Informaci√≥n personal (nombres, documento, foto)",
      "Programa acad√©mico y ciclo",
      "Informaci√≥n acad√©mica previa",
      "Experiencia laboral (si tiene)",
      "Firma digital"
    ],
    quienLoHace: "El estudiante",
    queDebeHacerAdmin: [
      "El estudiante recibir√° una confirmaci√≥n autom√°tica",
      "El registro aparecer√° en la secci√≥n 'Preinscripciones' del panel admin",
      "Esperar a que el estudiante est√© en semestre v√°lido para continuar"
    ],
    siguientePaso: "Cuando el estudiante est√© listo, se le notificar√° para subir el comprobante de pago"
  },
  {
    id: "stage2",
    numero: "PASO 2",
    title: "Validaci√≥n del Comprobante de Pago",
    icon: "CreditCard",
    color: "yellow",
    descripcion: "El estudiante sube su comprobante y t√∫ lo validas",
    queHace: "Proceso de dos partes:",
    pasos: [
      "El estudiante sube una imagen del comprobante de pago",
      "El comprobante aparece en 'Validar Pagos' del men√∫",
      "T√∫ revisas la imagen del comprobante",
      "Puedes aprobar o rechazar el pago"
    ],
    quienLoHace: "Estudiante sube, Admin o Registro y Control validan",
    queDebeHacerAdmin: [
      "Ve a 'Validar Pagos' en el men√∫ lateral",
      "Ver√°s una lista de pagos pendientes con foto del comprobante",
      "Haz clic en 'Aprobar' si el pago es v√°lido",
      "O haz clic en 'Rechazar' si hay alg√∫n problema (puedes agregar comentarios)"
    ],
    siguientePaso: "Si apruebas el pago, el practicante pasar√° a 'Estudiantes por Crear'"
  },
  {
    id: "stage3",
    numero: "PASO 3",
    title: "Creaci√≥n del Usuario Estudiante",
    icon: "UserCheck",
    color: "green",
    descripcion: "Creas el usuario para que el estudiante acceda al sistema",
    queHace: "El administrador crea las credenciales de acceso:",
    pasos: [
      "Los practicantes con pago validado aparecen aqu√≠",
      "Seleccionas un practicante para crear su usuario",
      "Asignas un nombre de usuario (por defecto su documento)",
      "Generas o escribes una contrase√±a temporal",
      "El sistema crea el usuario autom√°ticamente"
    ],
    quienLoHace: "Solo el Administrador",
    queDebeHacerAdmin: [
      "Ve a 'Crear Estudiantes' en el men√∫ lateral",
      "Haz clic en 'Crear Estudiante' en la tarjeta del practicante",
      "Confirma o cambia el nombre de usuario",
      "Genera una contrase√±a (hay un bot√≥n para generar autom√°ticamente)",
      "Guarda las credenciales y env√≠aselas al estudiante por email/WhatsApp",
      "¬°Listo! El estudiante ya puede acceder al sistema"
    ],
    siguientePaso: "El estudiante ya tiene acceso al sistema y puede ver su perfil y opciones de pr√°cticas"
  }
];
---

<AdminLayout title="Documentaci√≥n del Flujo | FESC">
  <div class="space-y-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        Documentaci√≥n del Flujo de Preinscripci√≥n
      </h1>
      <p class="text-gray-600">
        Gu√≠a completa del sistema de preinscripci√≥n de pr√°cticas profesionales
      </p>
    </div>

    <!-- Flujo Visual Completo -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-sm p-6 text-white">
      <h2 class="text-2xl font-bold mb-4">Flujo Visual Completo</h2>
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex flex-col items-center">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-2">
            <FileText className="w-8 h-8 text-blue-600" />
          </div>
          <span class="text-sm font-medium">Preinscripci√≥n</span>
        </div>
        <div class="flex-1 h-1 bg-white mx-2 min-w-[40px]"></div>
        <div class="flex flex-col items-center">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-2">
            <CreditCard className="w-8 h-8 text-yellow-600" />
          </div>
          <span class="text-sm font-medium">Validaci√≥n Pago</span>
        </div>
        <div class="flex-1 h-1 bg-white mx-2 min-w-[40px]"></div>
        <div class="flex flex-col items-center">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-2">
            <UserCheck className="w-8 h-8 text-green-600" />
          </div>
          <span class="text-sm font-medium">Creaci√≥n Usuario</span>
        </div>
        <div class="flex-1 h-1 bg-white mx-2 min-w-[40px]"></div>
        <div class="flex flex-col items-center">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-2">
            <Users className="w-8 h-8 text-purple-600" />
          </div>
          <span class="text-sm font-medium">Estudiante Activo</span>
        </div>
      </div>
    </div>

    <!-- Stages -->
    {stages.map((stage, index) => (
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <details class="group" open={index === 0}>
          <summary class="cursor-pointer p-6 hover:bg-gray-50 transition-colors list-none flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class={`w-16 h-16 rounded-lg flex items-center justify-center ${
                stage.color === 'blue' ? 'bg-blue-100 text-blue-800 border-2 border-blue-300' :
                stage.color === 'yellow' ? 'bg-yellow-100 text-yellow-800 border-2 border-yellow-300' :
                'bg-green-100 text-green-800 border-2 border-green-300'
              }`}>
                {stage.icon === "FileText" && <FileText className="w-8 h-8" />}
                {stage.icon === "CreditCard" && <CreditCard className="w-8 h-8" />}
                {stage.icon === "UserCheck" && <UserCheck className="w-8 h-8" />}
              </div>
              <div class="text-left">
                <span class={`text-xs font-bold uppercase tracking-wider ${
                  stage.color === 'blue' ? 'text-blue-600' :
                  stage.color === 'yellow' ? 'text-yellow-600' :
                  'text-green-600'
                }`}>{stage.numero}</span>
                <h3 class="text-xl font-bold text-gray-800">{stage.title}</h3>
                <p class="text-sm text-gray-600 mt-1">{stage.descripcion}</p>
              </div>
            </div>
            <ChevronDown className="w-6 h-6 text-gray-400 group-open:rotate-180 transition-transform" />
          </summary>

          <div class="px-6 pb-6 border-t border-gray-200 bg-gray-50">
            <div class="mt-6 space-y-6">
              <!-- Qu√© hace -->
              <div>
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs">?</span>
                  ¬øQu√© sucede en este paso?
                </h4>
                <p class="text-sm text-gray-600 mb-2">{stage.queHace}</p>
                <ul class="space-y-2">
                  {stage.pasos.map((paso) => (
                    <li class="flex items-start gap-2 text-sm text-gray-700">
                      <span class="text-blue-500 mt-1">‚úì</span>
                      <span>{paso}</span>
                    </li>
                  ))}
                </ul>
              </div>

              <!-- Qui√©n lo hace -->
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <span class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs">üë§</span>
                  ¬øQui√©n lo hace?
                </h4>
                <p class="text-sm text-gray-700 font-medium">{stage.quienLoHace}</p>
              </div>

              <!-- Qu√© debe hacer el admin -->
              <div>
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs">‚úì</span>
                  Instrucciones para ti:
                </h4>
                <ol class="space-y-3">
                  {stage.queDebeHacerAdmin.map((instruccion, idx) => (
                    <li class="flex items-start gap-3 text-sm text-gray-700">
                      <span class="flex-shrink-0 w-6 h-6 bg-green-100 text-green-700 rounded-full flex items-center justify-center font-bold text-xs">
                        {idx + 1}
                      </span>
                      <span class="pt-0.5">{instruccion}</span>
                    </li>
                  ))}
                </ol>
              </div>

              <!-- Siguiente paso -->
              <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded">
                <h4 class="text-sm font-bold text-indigo-900 mb-2">‚û°Ô∏è Siguiente paso:</h4>
                <p class="text-sm text-indigo-800">{stage.siguientePaso}</p>
              </div>
            </div>
          </div>
        </details>
      </div>
    ))}

    <!-- Resumen Visual de Estados -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Resumen: ¬øD√≥nde est√° cada estudiante?</h3>
      <p class="text-sm text-gray-600 mb-6">Estos son los estados en los que puede estar un estudiante durante el proceso:</p>

      <div class="space-y-3">
        <div class="flex items-center gap-3 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
          <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
          <div>
            <p class="font-bold text-blue-900">Preinscrito</p>
            <p class="text-sm text-blue-700">Complet√≥ el formulario inicial, esperando subir comprobante de pago</p>
          </div>
        </div>

        <div class="flex items-center gap-3 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
          <div class="w-10 h-10 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
          <div>
            <p class="font-bold text-yellow-900">Pago Pendiente</p>
            <p class="text-sm text-yellow-700">Subi√≥ comprobante, esperando que t√∫ lo valides</p>
          </div>
        </div>

        <div class="flex items-center gap-3 p-4 bg-green-50 border-l-4 border-green-500 rounded">
          <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
          <div>
            <p class="font-bold text-green-900">Pago Validado</p>
            <p class="text-sm text-green-700">Aprobaste el pago, listo para crear su usuario</p>
          </div>
        </div>

        <div class="flex items-center gap-3 p-4 bg-purple-50 border-l-4 border-purple-500 rounded">
          <div class="w-10 h-10 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold">‚úì</div>
          <div>
            <p class="font-bold text-purple-900">Estudiante Creado</p>
            <p class="text-sm text-purple-700">Usuario creado, ya puede acceder al sistema</p>
          </div>
        </div>

        <div class="flex items-center gap-3 p-4 bg-red-50 border-l-4 border-red-500 rounded">
          <div class="w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center font-bold">‚úï</div>
          <div>
            <p class="font-bold text-red-900">Rechazado</p>
            <p class="text-sm text-red-700">Rechazaste el pago o hay alg√∫n problema</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tips y Consejos -->
    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200 rounded-xl p-6">
      <h3 class="text-lg font-bold text-orange-900 mb-4 flex items-center gap-2">
        üí° Tips y Recordatorios Importantes
      </h3>
      <div class="space-y-3 text-sm text-orange-900">
        <div class="flex items-start gap-3">
          <span class="text-orange-500 font-bold">1.</span>
          <p><strong>Orden del proceso:</strong> Los estudiantes siempre siguen el orden Paso 1 ‚Üí Paso 2 ‚Üí Paso 3. No se puede saltar pasos.</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-orange-500 font-bold">2.</span>
          <p><strong>Validar pagos:</strong> Tanto t√∫ (admin) como los usuarios con rol "Registro y Control" pueden validar pagos.</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-orange-500 font-bold">3.</span>
          <p><strong>Crear estudiantes:</strong> Solo t√∫ como administrador puedes crear los usuarios estudiantes (Paso 3).</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-orange-500 font-bold">4.</span>
          <p><strong>Badges en el men√∫:</strong> Los n√∫meros que ves en el men√∫ lateral te indican cu√°ntas tareas tienes pendientes en cada secci√≥n.</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-orange-500 font-bold">5.</span>
          <p><strong>Rechazo de pagos:</strong> Si rechazas un pago, el estudiante ver√° tus comentarios y podr√° volver a subir otro comprobante.</p>
        </div>
      </div>
    </div>

    <!-- Ayuda adicional -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-center">
      <h3 class="text-lg font-bold text-blue-900 mb-2">¬øNecesitas m√°s ayuda?</h3>
      <p class="text-sm text-blue-700 mb-4">
        Si tienes dudas sobre c√≥mo usar el sistema, contacta al equipo t√©cnico o revisa esta gu√≠a nuevamente.
      </p>
      <p class="text-xs text-blue-600">
        Esta documentaci√≥n se actualiza autom√°ticamente con cada cambio en el sistema.
      </p>
    </div>
  </div>
</AdminLayout>
