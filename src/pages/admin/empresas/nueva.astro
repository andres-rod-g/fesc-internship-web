---
import AdminLayout from "~/layouts/AdminLayout.astro";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  console.log("Token inválido o no presente. Redirigiendo al login.");
  return Astro.redirect("/login");
}
---
<AdminLayout title="Nueva Empresa | FESC">
  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Navegación -->
    <div class="mb-6">
      <nav class="flex items-center space-x-2 text-sm text-gray-600">
        <a href="/admin/dashboard" class="hover:text-accent transition-colors">Dashboard</a>
        <span>/</span>
        <a href="/admin/empresas" class="hover:text-accent transition-colors">Empresas</a>
        <span>/</span>
        <span class="text-gray-800">Nueva Empresa</span>
      </nav>
    </div>

    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Crear Nueva Empresa</h1>
          <p class="text-gray-600">Registra una nueva empresa colaboradora</p>
        </div>
        <div class="flex gap-2">
          <a href="/admin/empresas" class="btn-secondary">
            Cancelar
          </a>
          <button id="crear-empresa" class="btn-primary">
            Crear Empresa
          </button>
        </div>
      </div>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <form id="empresa-form" class="space-y-6">
        <!-- Información Básica -->
        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Información Básica</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nombre de la Empresa *
              </label>
              <input type="text" id="nombre" name="nombre" class="input-primary" required>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                NIT
              </label>
              <input type="text" id="nit" name="nit" class="input-primary" placeholder="123456789-0">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Sector
              </label>
              <select id="sector" name="sector" class="input-primary">
                <option value="">Selecciona un sector</option>
                <option value="Tecnología">Tecnología</option>
                <option value="Salud">Salud</option>
                <option value="Educación">Educación</option>
                <option value="Comercio">Comercio</option>
                <option value="Manufactura">Manufactura</option>
                <option value="Servicios">Servicios</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tamaño
              </label>
              <select id="tamaño" name="tamaño" class="input-primary">
                <option value="">Selecciona el tamaño</option>
                <option value="Pequeña">Pequeña (1-50 empleados)</option>
                <option value="Mediana">Mediana (51-200 empleados)</option>
                <option value="Grande">Grande (201+ empleados)</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tipo de Vinculación *
              </label>
              <select id="tipo_vinculacion" name="tipo_vinculacion" class="input-primary" required>
                <option value="">Selecciona el tipo</option>
                <option value="convenio">Convenio</option>
                <option value="contrato_aprendizaje">Contrato de Aprendizaje</option>
              </select>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Dirección
              </label>
              <input type="text" id="direccion" name="direccion" class="input-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Teléfono
              </label>
              <input type="tel" id="telefono" name="telefono" class="input-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Email
              </label>
              <input type="email" id="email" name="email" class="input-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Sitio Web
              </label>
              <input type="url" id="sitio_web" name="sitio_web" class="input-primary" placeholder="https://example.com">
            </div>
          </div>
        </div>

        <!-- Información de Contacto -->
        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Persona de Contacto</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nombre del Contacto
              </label>
              <input type="text" id="contacto_nombre" name="contacto_nombre" class="input-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Cargo
              </label>
              <input type="text" id="contacto_cargo" name="contacto_cargo" class="input-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Teléfono de Contacto
              </label>
              <input type="tel" id="contacto_telefono" name="contacto_telefono" class="input-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Email de Contacto
              </label>
              <input type="email" id="contacto_email" name="contacto_email" class="input-primary">
            </div>
          </div>
        </div>

        <!-- Información Adicional -->
        <div>
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Información Adicional</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Descripción
              </label>
              <textarea id="descripcion" name="descripcion" rows="4" class="input-primary resize-none" placeholder="Describe la empresa, sus actividades principales, etc."></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Áreas de Práctica Disponibles
              </label>
              <textarea id="areas_practica" name="areas_practica" rows="3" class="input-primary resize-none" placeholder="Ej: Desarrollo de software, Diseño gráfico, Marketing digital, etc."></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Número Máximo de Practicantes
              </label>
              <input type="number" id="max_practicantes" name="max_practicantes" class="input-primary" min="1" placeholder="5">
            </div>
          </div>
        </div>

        <!-- Mensaje de estado -->
        <div id="mensaje" class="hidden p-4 rounded-lg"></div>
        
        <!-- Botones de acción -->
        <div class="flex justify-end gap-4">
          <a href="/admin/empresas" class="btn-secondary">
            Cancelar
          </a>
          <button type="submit" class="btn-primary">
            Crear Empresa
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline>
  document.getElementById('empresa-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
      nombre: formData.get('nombre'),
      nit: formData.get('nit'),
      sector: formData.get('sector'),
      tamaño: formData.get('tamaño'),
      tipo_vinculacion: formData.get('tipo_vinculacion'),
      direccion: formData.get('direccion'),
      telefono: formData.get('telefono'),
      email: formData.get('email'),
      sitio_web: formData.get('sitio_web'),
      contacto_nombre: formData.get('contacto_nombre'),
      contacto_cargo: formData.get('contacto_cargo'),
      contacto_telefono: formData.get('contacto_telefono'),
      contacto_email: formData.get('contacto_email'),
      descripcion: formData.get('descripcion'),
      areas_practica: formData.get('areas_practica'),
      max_practicantes: formData.get('max_practicantes') ? parseInt(formData.get('max_practicantes')) : null
    };
    
    try {
      const response = await fetch('/api/empresas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      
      const result = await response.json();
      const mensaje = document.getElementById('mensaje');
      
      if (response.ok) {
        mensaje.className = 'p-4 rounded-lg bg-green-100 text-green-800';
        mensaje.textContent = 'Empresa creada exitosamente';
        mensaje.classList.remove('hidden');
        
        setTimeout(() => {
          window.location.href = '/admin/empresas';
        }, 2000);
      } else {
        mensaje.className = 'p-4 rounded-lg bg-red-100 text-red-800';
        mensaje.textContent = result.error || 'Error al crear la empresa';
        mensaje.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error:', error);
      const mensaje = document.getElementById('mensaje');
      mensaje.className = 'p-4 rounded-lg bg-red-100 text-red-800';
      mensaje.textContent = 'Error de conexión al servidor';
      mensaje.classList.remove('hidden');
    }
  });
</script>