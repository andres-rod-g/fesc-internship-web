---
import AdminLayout from "~/layouts/AdminLayout.astro";
import BuscadorPracticantes from "~/components/admin/BuscadorPracticantes.jsx";
import TablaPracticantes from "~/components/admin/TablaPracticantes.jsx";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  return Astro.redirect("/login");
}

if (user.role !== "admin") {
  return Astro.redirect("/admin/validaciones-pago");
}
---

<AdminLayout title="Practicantes | FESC">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
      <div>
        <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-2">
          <a href="/admin/dashboard" class="hover:text-accent transition-colors">Dashboard</a>
          <span>/</span>
          <span class="text-gray-800">Practicantes</span>
        </nav>
        <h1 class="text-3xl font-bold text-gray-800">Gestión de Practicantes</h1>
        <p class="text-gray-600 mt-1">Administra y supervisa el estado de las prácticas profesionales</p>
      </div>
      <a href="/admin/nuevo-practicante" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Nuevo Practicante
      </a>
    </div>

    <!-- Buscador y Filtros -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Buscar y Filtrar</h2>
      <BuscadorPracticantes client:load />
    </div>

    <!-- Tabla de practicantes (dinámica) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">Lista de Practicantes</h2>
      </div>

      <div id="tabla-container"></div>
    </div>

    <!-- Paginación -->
    <div id="pagination-container"></div>
  </div>
</AdminLayout>

<script is:inline>
  console.log("Script inline ejecutandose");

  let currentPage = 1;
  window.currentResults = [];
  window.currentPagination = null;
  let sortField = "createdAt";
  let sortDirection = "desc";

  function sortData(data, field, direction) {
    const sorted = [...data].sort(function(a, b) {
      let valueA = a[field] || "";
      let valueB = b[field] || "";

      if (field === "createdAt") {
        valueA = new Date(valueA).getTime();
        valueB = new Date(valueB).getTime();
      } else if (typeof valueA === "string") {
        valueA = valueA.toLowerCase();
        valueB = valueB.toLowerCase();
      }

      if (valueA < valueB) return direction === "asc" ? -1 : 1;
      if (valueA > valueB) return direction === "asc" ? 1 : -1;
      return 0;
    });
    return sorted;
  }

  window.handleSort = function(field) {
    if (sortField === field) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      sortField = field;
      sortDirection = "asc";
    }
    window.updateTablaVista();
  };

  window.getEstadoLabel = function(estado) {
    const labels = {
      'preinscrito': 'Preinscrito',
      'pago_pendiente': 'Pago Pendiente',
      'pago_validado': 'Pago Validado',
      'estudiante_creado': 'Estudiante Creado'
    };
    return labels[estado] || estado;
  };

  window.getEstadoLaboralLabel = function(estado) {
    const labels = {
      'seeking_internship': 'Buscando prácticas',
      'working': 'Trabajando',
      'entrepreneur': 'Emprendedor'
    };
    return labels[estado] || estado;
  };

  window.getEstadoBadge = function(estado) {
    const badges = {
      'preinscrito': 'bg-blue-100 text-blue-800',
      'pago_pendiente': 'bg-yellow-100 text-yellow-800',
      'pago_validado': 'bg-green-100 text-green-800',
      'estudiante_creado': 'bg-purple-100 text-purple-800'
    };
    const color = badges[estado] || 'bg-gray-100 text-gray-800';
    const label = window.getEstadoLabel(estado);
    return '<span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full ' + color + '">' + label + '</span>';
  };

  window.getEstadoLaboralBadge = function(estado) {
    const badges = {
      'seeking_internship': 'bg-blue-100 text-blue-800',
      'working': 'bg-green-100 text-green-800',
      'entrepreneur': 'bg-purple-100 text-purple-800'
    };
    const color = badges[estado] || 'bg-gray-100 text-gray-800';
    const label = window.getEstadoLaboralLabel(estado);
    return '<span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full ' + color + '">' + label + '</span>';
  };

  window.getEstadoPracticaBadge = function(estado) {
    if (!estado) return '<span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Sin asignar</span>';
    const badges = {
      'pendiente': 'bg-yellow-100 text-yellow-800',
      'activo': 'bg-blue-100 text-blue-800',
      'completado': 'bg-green-100 text-green-800'
    };
    const color = badges[estado] || 'bg-gray-100 text-gray-800';
    return '<span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full ' + color + '">' + estado + '</span>';
  };

  window.updateTablaVista = function() {
    const container = document.getElementById('tabla-container');
    if (!window.currentResults || window.currentResults.length === 0) {
      container.innerHTML = '<div class="p-8 text-center"><p class="text-gray-500">Realiza una búsqueda o aplica filtros para ver los practicantes</p></div>';
      return;
    }

    const sortedData = sortData(window.currentResults, sortField, sortDirection);
    let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';

    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="window.handleSort(\'nombres\')">Practicante</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="window.handleSort(\'correo_institucional\')">Correo</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="window.handleSort(\'numero_documento\')">Cedula</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="window.handleSort(\'estado_laboral\')">Estado Laboral</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="window.handleSort(\'estado_preinscripcion\')">Estado</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado Practica</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="window.handleSort(\'createdAt\')">Fecha Creacion</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gestion</th>';
    html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>';
    html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

    sortedData.forEach(function(p) {
      const fotoUrl = p.foto_url || '/api/practicantes/' + p._id + '/foto';
      const name = (p.nombres || '') + ' ' + (p.apellidos || '');
      const programa = p.programa || 'No especificado';
      const fecha = new Date(p.createdAt).toLocaleDateString('es-ES');

      let gestionBadge = '';
      if (p.estado_preinscripcion === 'estudiante_creado') {
        gestionBadge = '<span class="inline-block bg-green-100 text-green-800 px-2 py-1 text-xs rounded mr-1">Pago OK</span><span class="inline-block bg-green-100 text-green-800 px-2 py-1 text-xs rounded">Usuario OK</span>';
      } else if (p.estado_preinscripcion === 'pago_validado') {
        gestionBadge = '<span class="inline-block bg-green-100 text-green-800 px-2 py-1 text-xs rounded mr-1">Pago OK</span><span class="inline-block bg-orange-100 text-orange-800 px-2 py-1 text-xs rounded">Usuario Pendiente</span>';
      } else {
        gestionBadge = '<span class="inline-block bg-red-100 text-red-800 px-2 py-1 text-xs rounded">Pago No Validado</span>';
      }

      html += '<tr class="hover:bg-gray-50">';
      html += '<td class="px-6 py-4 whitespace-nowrap text-left"><div class="flex items-center gap-2"><img src="' + fotoUrl + '" alt="' + name + '" class="w-10 h-10 rounded-full object-cover bg-gray-200" /><div><div class="text-sm font-medium text-gray-900">' + name + '</div><div class="text-xs text-gray-500">' + programa + '</div></div></div></td>';
      html += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">' + (p.correo_institucional || '-') + '</td>';
      html += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">' + (p.numero_documento || '-') + '</td>';
      html += '<td class="px-6 py-4 whitespace-nowrap">' + window.getEstadoLaboralBadge(p.estado_laboral) + '</td>';
      html += '<td class="px-6 py-4 whitespace-nowrap">' + window.getEstadoBadge(p.estado_preinscripcion) + '</td>';

      const empresaCell = p.empresa_info && p.empresa_info.empresa_nombre
        ? '<a href="/admin/empresas/' + p.empresa_info.empresa_id + '" class="text-red-600 hover:text-red-800 font-medium">' + p.empresa_info.empresa_nombre + '</a>'
        : '<span class="text-gray-400">Sin asignar</span>';
      html += '<td class="px-6 py-4 whitespace-nowrap text-sm">' + empresaCell + '</td>';

      html += '<td class="px-6 py-4 whitespace-nowrap">' + window.getEstadoPracticaBadge(p.estado_practica_en_empresa) + '</td>';
      html += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">' + fecha + '</td>';
      html += '<td class="px-6 py-4 whitespace-nowrap text-xs">' + gestionBadge + '</td>';
      html += '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><a href="/admin/practicantes/' + p._id + '" class="text-red-600 hover:text-red-800">Ver detalles</a></td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
  };

  window.renderPaginacion = function() {
    const container = document.getElementById('pagination-container');
    if (!window.currentPagination || window.currentPagination.totalPages <= 1) {
      container.innerHTML = '';
      return;
    }
    const p = window.currentPagination;
    let html = '<div class="flex items-center justify-between px-4 py-3 bg-white rounded-lg border border-gray-200">';
    html += '<div class="text-sm text-gray-600">Mostrando ' + p.total + ' practicantes (Pagina ' + currentPage + ' de ' + p.totalPages + ')</div>';
    html += '<div class="flex items-center gap-1">';
    if (currentPage > 1) {
      html += '<button onclick="window.changePage(' + (currentPage - 1) + ')" class="p-2">Anterior</button>';
    }
    html += '<button onclick="window.changePage(1)">1</button>';
    if (p.totalPages > 1) {
      html += '<button onclick="window.changePage(' + p.totalPages + ')">' + p.totalPages + '</button>';
    }
    if (currentPage < p.totalPages) {
      html += '<button onclick="window.changePage(' + (currentPage + 1) + ')" class="p-2">Siguiente</button>';
    }
    html += '</div></div>';
    container.innerHTML = html;
  };

  window.changePage = function(page) {
    currentPage = page;
    if (window.onPageChangeFromBuscador) {
      window.onPageChangeFromBuscador(page);
    }
  };
</script>
