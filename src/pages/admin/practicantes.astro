---
import AdminLayout from "~/layouts/AdminLayout.astro";
import BuscadorPracticantes from "~/components/admin/BuscadorPracticantes.jsx";
import TablaPracticantes from "~/components/admin/TablaPracticantes.jsx";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  return Astro.redirect("/login");
}

if (user.role !== "admin") {
  return Astro.redirect("/admin/validaciones-pago");
}
---

<AdminLayout title="Practicantes | FESC">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
      <div>
        <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-2">
          <a href="/admin/dashboard" class="hover:text-accent transition-colors">Dashboard</a>
          <span>/</span>
          <span class="text-gray-800">Practicantes</span>
        </nav>
        <h1 class="text-3xl font-bold text-gray-800">Gestión de Practicantes</h1>
        <p class="text-gray-600 mt-1">Administra y supervisa el estado de las prácticas profesionales</p>
      </div>
      <a href="/admin/nuevo-practicante" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Nuevo Practicante
      </a>
    </div>

    <!-- Buscador y Filtros -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Buscar y Filtrar</h2>
      <BuscadorPracticantes client:load />
    </div>

    <!-- Tabla de practicantes (dinámica) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">Lista de Practicantes</h2>
      </div>

      <div id="tabla-container"></div>
    </div>

    <!-- Paginación -->
    <div id="pagination-container"></div>
  </div>
</AdminLayout>

<script is:inline>
  // Global state
  let currentPage = 1;
  window.currentResults = [];
  window.currentPagination = null;
  let sortField = "createdAt";
  let sortDirection = "desc";

  function sortData(data, field, direction) {
    const sorted = [...data].sort((a, b) => {
      let valueA = a[field] || "";
      let valueB = b[field] || "";

      // Handle dates
      if (field === "createdAt") {
        valueA = new Date(valueA).getTime();
        valueB = new Date(valueB).getTime();
      } else if (typeof valueA === "string") {
        valueA = valueA.toLowerCase();
        valueB = valueB.toLowerCase();
      }

      if (valueA < valueB) return direction === "asc" ? -1 : 1;
      if (valueA > valueB) return direction === "asc" ? 1 : -1;
      return 0;
    });
    return sorted;
  }

  window.handleSort = (field) => {
    if (sortField === field) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      sortField = field;
      sortDirection = "asc";
    }
    updateTablaVista();
  };

  function updateTablaVista() {
    const tablaContainer = document.getElementById('tabla-container');

    if (!window.currentResults || window.currentResults.length === 0) {
      tablaContainer.innerHTML = `
        <div class="p-8 text-center">
          <p class="text-gray-500">Realiza una búsqueda o aplica filtros para ver los practicantes</p>
        </div>
      `;
      return;
    }

    // Sort the data
    const sortedData = sortData(window.currentResults, sortField, sortDirection);

    // Generar tabla HTML
    let html = `
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSort('nombres')">
                Practicante ${sortField === 'nombres' ? (sortDirection === 'asc' ? '↑' : '↓') : ''}
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSort('correo_institucional')">
                Correo ${sortField === 'correo_institucional' ? (sortDirection === 'asc' ? '↑' : '↓') : ''}
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSort('numero_documento')">
                Cédula ${sortField === 'numero_documento' ? (sortDirection === 'asc' ? '↑' : '↓') : ''}
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSort('estado_laboral')">
                Estado Laboral ${sortField === 'estado_laboral' ? (sortDirection === 'asc' ? '↑' : '↓') : ''}
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.handleSort('createdAt')">
                Fecha Creación ${sortField === 'createdAt' ? (sortDirection === 'asc' ? '↑' : '↓') : ''}
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gestión</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
    `;

    sortedData.forEach(p => {
      const estadoLaboralColors = {
        'seeking_internship': 'bg-blue-100 text-blue-800',
        'working': 'bg-green-100 text-green-800',
        'entrepreneur': 'bg-purple-100 text-purple-800'
      };

      const estadoLaboralLabels = {
        'seeking_internship': 'Busca prácticas',
        'working': 'Trabaja',
        'entrepreneur': 'Emprendedor'
      };

      const formatDate = (date) => {
        return new Date(date).toLocaleDateString('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      };

      const colorClass = estadoLaboralColors[p.estado_laboral] || 'bg-gray-100 text-gray-800';
      const labelEstado = estadoLaboralLabels[p.estado_laboral] || 'No especificado';
      const fechaFormato = formatDate(p.createdAt);

      let gestionHTML = '';
      if (p.estado_preinscripcion === 'estudiante_creado') {
        gestionHTML = `
          <div class="flex flex-col gap-1">
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full w-fit">
              ✓ Pago
            </span>
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full w-fit">
              ✓ Usuario
            </span>
          </div>
        `;
      } else if (p.estado_preinscripcion === 'pago_validado') {
        gestionHTML = `
          <div class="flex flex-col gap-1">
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full w-fit">
              ✓ Pago
            </span>
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-orange-100 text-orange-800 text-xs font-semibold rounded-full w-fit">
              ⚠️ Usuario pendiente
            </span>
          </div>
        `;
      } else {
        gestionHTML = `
          <div class="flex flex-col gap-1">
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full w-fit">
              ✗ Pago no validado
            </span>
          </div>
        `;
      }

      html += `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4 whitespace-nowrap text-left">
            <div class="flex items-center gap-3">
              <img src="${p.foto_url || `/api/practicantes/${p._id}/foto`}" alt="${p.nombres} ${p.apellidos}" class="w-10 h-10 rounded-full object-cover bg-gray-200" />
              <div>
                <div class="text-sm font-medium text-gray-900">${p.nombres} ${p.apellidos}</div>
                <div class="text-xs text-gray-500">${p.programa || 'No especificado'}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-600">${p.correo_institucional || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-600">${p.numero_documento || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full ${colorClass}">
              ${labelEstado}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-600">${fechaFormato}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${gestionHTML}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <a href="/admin/practicantes/${p._id}" class="text-accent hover:text-red-700 font-medium">
              Ver detalles
            </a>
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;

    tablaContainer.innerHTML = html;
  }

  function renderPaginacion() {
    const paginationContainer = document.getElementById('pagination-container');

    if (!window.currentPagination || window.currentPagination.totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    const pagination = window.currentPagination;
    paginationContainer.innerHTML = `
      <div class="flex items-center justify-between px-4 py-3 bg-white rounded-lg border border-gray-200">
        <div class="text-sm text-gray-600">
          Mostrando <span class="font-semibold">${pagination.total}</span> practicantes
          (Página <span class="font-semibold">${currentPage}</span> de
          <span class="font-semibold">${pagination.totalPages}</span>)
        </div>
        <div class="flex items-center gap-1">
          <button
            onclick="changePage(${currentPage - 1})"
            ${currentPage === 1 ? 'disabled' : ''}
            class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
          >
            ◀
          </button>
          ${Array.from({ length: pagination.totalPages }, (_, i) => i + 1)
            .filter(p => Math.abs(p - currentPage) <= 2 || p === 1 || p === pagination.totalPages)
            .map(page => `
              <button
                onclick="changePage(${page})"
                class="px-3 py-1 rounded-lg text-sm font-medium transition-colors ${
                  page === currentPage
                    ? 'bg-red-600 text-white'
                    : 'text-gray-700 hover:bg-gray-100'
                }"
              >
                ${page}
              </button>
            `).join('')}
          <button
            onclick="changePage(${currentPage + 1})"
            ${currentPage === pagination.totalPages ? 'disabled' : ''}
            class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50"
          >
            ▶
          </button>
        </div>
      </div>
    `;
  }

  window.changePage = (page) => {
    console.log("changePage called with page:", page);
    currentPage = page;
    if (window.onPageChangeFromBuscador) {
      window.onPageChangeFromBuscador(page);
    }
  };
</script>
