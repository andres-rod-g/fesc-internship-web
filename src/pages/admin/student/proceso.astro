---
import StudentLayout from "../../../layouts/StudentLayout.astro";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";
import { connectDB } from "~/utils/db.js";
import { ObjectId } from "mongodb";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user || user.role !== "estudiante") {
  return Astro.redirect("/login");
}

const db = await connectDB();

// Obtener todos los procesos de prácticas del estudiante
const procesos = await db
  .collection("proceso-practicas")
  .find({
    estudianteId: new ObjectId(user.id)
  })
  .toArray();

// Enriquecer procesos con información del grupo
const procesosConGrupo = await Promise.all(
  procesos.map(async (proceso) => {
    const grupo = await db
      .collection("grupos")
      .findOne({ _id: proceso.grupoId });

    return {
      _id: proceso._id.toString(),
      estudianteId: proceso.estudianteId.toString(),
      grupoId: proceso.grupoId.toString(),
      grupo,
      esConsultoria: proceso.esConsultoria || false,
      createdAt: proceso.createdAt,
      updatedAt: proceso.updatedAt
    };
  })
);
---

<StudentLayout title="Mis Procesos de Prácticas | FESC" activeTab="proceso">
  <div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Mis Procesos de Prácticas</h1>
      <p class="text-gray-600">
        Aquí puedes ver y gestionar tus procesos de prácticas
      </p>
    </div>

    <!-- Lista de Procesos -->
    {procesosConGrupo.length > 0 ? (
      <div class="grid grid-cols-1 gap-4">
        {procesosConGrupo.map((proceso) => (
          <a
            href={`/admin/student/proceso/${proceso._id}`}
            class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer"
          >
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">
                  {proceso.grupo?.nombre || "Grupo sin nombre"}
                </h2>
                <div class="space-y-1 text-sm text-gray-600">
                  <p>Semestre: {proceso.grupo?.semestre || "N/A"}</p>
                  <p>
                    Tipo: {proceso.esConsultoria ? "Consultoría" : "Práctica Regular"}
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                  → Abrir
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center">
        <p class="text-yellow-800 font-medium">No tienes procesos de prácticas asignados</p>
        <p class="text-yellow-700 text-sm mt-2">
          Contacta con el administrador para ser asignado a un grupo
        </p>
      </div>
    )}
  </div>
</StudentLayout>
