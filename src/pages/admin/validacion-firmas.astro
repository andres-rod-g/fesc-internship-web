---
import AdminLayout from "~/layouts/AdminLayout.astro";
import ValidacionFirmasContent from "~/components/admin/ValidacionFirmasContent.jsx";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";
import { connectDB } from "~/utils/db.js";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  return Astro.redirect("/login");
}

if (!["admin", "director_practicas"].includes(user.role)) {
  return Astro.redirect("/admin/dashboard");
}

const db = await connectDB();

// Get all resources that require verification and are not yet verified (with URL)
const recursosNoVerificados = await db
  .collection("recursos")
  .find({
    verificacionRequerida: true,
    verificado: { $ne: true },
    $and: [
      { url: { $exists: true } },
      { url: { $ne: null } },
      { url: { $ne: "" } },
      { url: { $regex: /\S/ } }  // Must contain at least one non-whitespace character
    ]
  })
  .sort({ createdAt: -1 })
  .toArray();

// Populate with student and user details
const recursosConDetalles = await Promise.all(
  recursosNoVerificados.map(async (recurso) => {
    let usuario = null;
    let estudiante = null;

    // Get user/student details
    if (recurso.usuarioId) {
      usuario = await db
        .collection("users")
        .findOne({ _id: recurso.usuarioId });

      if (!usuario) {
        estudiante = await db
          .collection("estudiantes")
          .findOne({ _id: recurso.usuarioId });
      }
    }

    return {
      ...recurso,
      _id: recurso._id.toString(),
      usuario: usuario || estudiante,
    };
  })
);
---

<AdminLayout title="ValidaciÃ³n de Firmas | FESC">
  <ValidacionFirmasContent client:only="react" initialRecursos={recursosConDetalles} />
</AdminLayout>
