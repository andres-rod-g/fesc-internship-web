---
import AdminLayout from "~/layouts/AdminLayout.astro";
import ValidacionFirmasContent from "~/components/admin/ValidacionFirmasContent.jsx";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";
import { connectDB } from "~/utils/db.js";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  return Astro.redirect("/login");
}

if (!["admin", "director_practicas"].includes(user.role)) {
  return Astro.redirect("/admin/dashboard");
}

const db = await connectDB();

// Get all resources that require verification and are not yet verified (with URL) using aggregation
const query = {
  verificacionRequerida: true,
  verificado: { $ne: true },
  $and: [
    { url: { $exists: true } },
    { url: { $ne: null } },
    { url: { $ne: "" } },
    { url: { $regex: /\S/ } }
  ]
};

const recursosConDetalles = await db
  .collection("recursos")
  .aggregate([
    { $match: query },
    { $sort: { createdAt: -1 } },
    // Lookup users
    {
      $lookup: {
        from: "users",
        localField: "usuarioId",
        foreignField: "_id",
        as: "usuarioData"
      }
    },
    // Lookup estudiantes (fallback if no user found)
    {
      $lookup: {
        from: "estudiantes",
        localField: "usuarioId",
        foreignField: "_id",
        as: "estudianteData"
      }
    },
    // Lookup proceso-practicas
    {
      $lookup: {
        from: "proceso-practicas",
        localField: "procesoPracticasId",
        foreignField: "_id",
        as: "procesoData"
      }
    },
    // Add fields for easier processing
    {
      $addFields: {
        usuario: {
          $cond: [
            { $gt: [{ $size: "$usuarioData" }, 0] },
            { $arrayElemAt: ["$usuarioData", 0] },
            { $arrayElemAt: ["$estudianteData", 0] }
          ]
        },
        proceso: { $arrayElemAt: ["$procesoData", 0] }
      }
    },
    // Lookup grupos via proceso.grupoId
    {
      $lookup: {
        from: "grupos",
        localField: "proceso.grupoId",
        foreignField: "_id",
        as: "grupoData"
      }
    },
    // Lookup practicantes by email
    {
      $lookup: {
        from: "practicantes",
        let: { email: { $ifNull: ["$usuario.correo_institucional", "$usuario.email"] } },
        pipeline: [
          { $match: { $expr: { $eq: ["$correo_institucional", "$$email"] } } }
        ],
        as: "practicanteData"
      }
    },
    // Final projection
    {
      $project: {
        _id: { $toString: "$_id" },
        procesoPracticasId: 1,
        usuarioId: 1,
        tipo: 1,
        subtipo: 1,
        url: 1,
        titulo: 1,
        nota: 1,
        notasAdicionales: 1,
        verificacionRequerida: 1,
        verificado: 1,
        createdAt: 1,
        updatedAt: 1,
        usuario: 1,
        grupo: { $arrayElemAt: ["$grupoData", 0] },
        practicanteId: { $toString: { $arrayElemAt: ["$practicanteData._id", 0] } }
      }
    }
  ])
  .toArray();
---

<AdminLayout title="ValidaciÃ³n de Firmas | FESC">
  <ValidacionFirmasContent client:only="react" initialRecursos={recursosConDetalles} />
</AdminLayout>
