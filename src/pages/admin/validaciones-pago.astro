---
import AdminLayout from "~/layouts/AdminLayout.astro";
import jwt from "jsonwebtoken";
import { JWT_SECRET } from "~/env";
import { connectDB } from "~/utils/db.js";
import { CheckCircle, XCircle, Calendar, User, Eye } from "lucide-react";

const token = Astro.cookies.get("token")?.value;
let user = null;
if (token) {
  try {
    user = jwt.verify(token, JWT_SECRET);
  } catch (err) {
    console.error("Error al verificar el token:", err);
    user = null;
  }
}

if (!user) {
  return Astro.redirect("/login");
}

if (!["admin", "registro_control"].includes(user.role)) {
  return Astro.redirect("/admin/dashboard");
}

const db = await connectDB();

const practicantesPendientes = await db
  .collection("practicantes")
  .find({
    estado_preinscripcion: "pago_pendiente",
    "validacion_pago.estado": "pendiente"
  })
  .sort({ "validacion_pago.fecha_subida": -1 })
  .toArray();
---

<AdminLayout title="Validaciones de Pago | FESC">
  <div class="space-y-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Validaciones de Pago</h1>
          <p class="text-gray-600 mt-1">
            Revisa y valida los comprobantes de pago subidos por los estudiantes
          </p>
        </div>
        <span class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg font-semibold">
          {practicantesPendientes.length} pendientes
        </span>
      </div>
    </div>

    {practicantesPendientes.length === 0 ? (
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <CheckCircle className="w-8 h-8 text-gray-400" />
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">No hay validaciones pendientes</h3>
        <p class="text-gray-600">Todos los comprobantes han sido revisados</p>
      </div>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {practicantesPendientes.map((practicante) => {
          const comprobanteData = practicante.validacion_pago?.comprobante_url;
          const comprobanteUrl = comprobanteData
            ? `data:${comprobanteData.contentType};base64,${comprobanteData.data}`
            : null;
          const isPdf = comprobanteData?.contentType === 'application/pdf';

          return (
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-800">
                    {practicante.nombres} {practicante.apellidos}
                  </h3>
                  <p class="text-sm text-gray-600">{practicante.programa}</p>
                  <p class="text-sm text-gray-500">
                    Doc: {practicante.numero_documento}
                  </p>
                </div>
                <span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                  Pendiente
                </span>
              </div>

              <div class="space-y-2 mb-4 text-sm">
                <div class="flex items-center gap-2 text-gray-600">
                  <Calendar className="w-4 h-4" />
                  <span>
                    Subido: {new Date(practicante.validacion_pago?.fecha_subida).toLocaleDateString("es-ES")}
                  </span>
                </div>
                <div class="flex items-center gap-2 text-gray-600">
                  <User className="w-4 h-4" />
                  <span>{practicante.correo_institucional}</span>
                </div>
              </div>

              <div class="mb-4">
                {comprobanteUrl && (
                  <div class="relative group cursor-pointer" onclick={`verImagen('${comprobanteUrl}', ${isPdf})`}>
                    {isPdf ? (
                      <div class="w-full h-48 flex items-center justify-center bg-gray-100 rounded-lg border border-gray-300">
                        <div class="text-center">
                          <svg class="w-16 h-16 text-red-600 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                          </svg>
                          <p class="text-sm text-gray-600 font-medium">PDF</p>
                          <p class="text-xs text-gray-500 mt-1">Clic para ver</p>
                        </div>
                      </div>
                    ) : (
                      <>
                        <img
                          src={comprobanteUrl}
                          alt="Comprobante de pago"
                          class="w-full h-48 object-cover rounded-lg border border-gray-300"
                        />
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center rounded-lg">
                          <Eye className="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" />
                        </div>
                      </>
                    )}
                  </div>
                )}
              </div>

              <div class="flex gap-3">
                <button
                  onclick={`abrirModal('${practicante._id}', 'aprobar', '${practicante.nombres} ${practicante.apellidos}')`}
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                >
                  <CheckCircle className="w-4 h-4" />
                  Aprobar
                </button>
                <button
                  onclick={`abrirModal('${practicante._id}', 'rechazar', '${practicante.nombres} ${practicante.apellidos}')`}
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                >
                  <XCircle className="w-4 h-4" />
                  Rechazar
                </button>
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>

  <!-- Modal de validación -->
  <div id="modal-validacion" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
      <p id="modal-descripcion" class="text-gray-600 mb-4"></p>
      <p id="modal-estudiante" class="text-sm text-gray-500 mb-4 font-medium"></p>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Comentarios <span id="comentarios-requerido" class="hidden">(requerido)</span>
        </label>
        <textarea
          id="modal-comentarios"
          rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
          placeholder="Agrega comentarios adicionales..."
        ></textarea>
      </div>

      <div class="flex gap-3">
        <button
          onclick="cerrarModal()"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
        >
          Cancelar
        </button>
        <button
          id="modal-confirmar"
          onclick="confirmarValidacion()"
          class="flex-1 px-4 py-2 rounded-lg text-white transition-colors"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de imagen -->
  <div id="modal-imagen" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4" onclick="cerrarModalImagen()">
    <div class="max-w-4xl w-full">
      <img id="imagen-ampliada" class="w-full h-auto rounded-lg" alt="Comprobante ampliado" />
      <iframe id="pdf-viewer" class="w-full h-screen rounded-lg hidden"></iframe>
      <p class="text-white text-center mt-4">Clic para cerrar</p>
    </div>
  </div>
</AdminLayout>

<script is:inline>
  let modalData = { id: null, accion: null };

  function abrirModal(practicanteId, accion, nombreEstudiante) {
    modalData = { id: practicanteId, accion };
    const modal = document.getElementById('modal-validacion');
    const title = document.getElementById('modal-title');
    const descripcion = document.getElementById('modal-descripcion');
    const estudiante = document.getElementById('modal-estudiante');
    const confirmarBtn = document.getElementById('modal-confirmar');
    const comentariosRequerido = document.getElementById('comentarios-requerido');

    estudiante.textContent = `Estudiante: ${nombreEstudiante}`;

    if (accion === 'aprobar') {
      title.textContent = 'Aprobar Pago';
      descripcion.textContent = '¿Estás seguro de aprobar este pago? El practicante podrá continuar al siguiente paso.';
      confirmarBtn.className = 'flex-1 px-4 py-2 rounded-lg text-white transition-colors bg-green-600 hover:bg-green-700';
      comentariosRequerido.classList.add('hidden');
    } else {
      title.textContent = 'Rechazar Pago';
      descripcion.textContent = '¿Estás seguro de rechazar este pago? Debes agregar comentarios para el estudiante.';
      confirmarBtn.className = 'flex-1 px-4 py-2 rounded-lg text-white transition-colors bg-red-600 hover:bg-red-700';
      comentariosRequerido.classList.remove('hidden');
    }

    modal.classList.remove('hidden');
  }

  function cerrarModal() {
    document.getElementById('modal-validacion').classList.add('hidden');
    document.getElementById('modal-comentarios').value = '';
    modalData = { id: null, accion: null };
  }

  async function confirmarValidacion() {
    const comentarios = document.getElementById('modal-comentarios').value.trim();

    if (modalData.accion === 'rechazar' && !comentarios) {
      alert('Debes agregar comentarios al rechazar un pago');
      return;
    }

    const confirmarBtn = document.getElementById('modal-confirmar');
    confirmarBtn.disabled = true;
    confirmarBtn.textContent = 'Procesando...';

    try {
      const res = await fetch('/api/validacion-pago/validar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          practicante_id: modalData.id,
          accion: modalData.accion,
          comentarios
        })
      });

      if (res.ok) {
        window.location.reload();
      } else {
        const data = await res.json();
        alert(data.error || 'Error al validar pago');
        confirmarBtn.disabled = false;
        confirmarBtn.textContent = 'Confirmar';
      }
    } catch (error) {
      alert('Error de conexión');
      confirmarBtn.disabled = false;
      confirmarBtn.textContent = 'Confirmar';
    }
  }

  function verImagen(url, isPdf) {
    const modal = document.getElementById('modal-imagen');
    const imagen = document.getElementById('imagen-ampliada');
    const pdfViewer = document.getElementById('pdf-viewer');

    if (isPdf) {
      imagen.classList.add('hidden');
      pdfViewer.classList.remove('hidden');
      pdfViewer.src = url;
    } else {
      pdfViewer.classList.add('hidden');
      imagen.classList.remove('hidden');
      imagen.src = url;
    }

    modal.classList.remove('hidden');
  }

  function cerrarModalImagen() {
    document.getElementById('modal-imagen').classList.add('hidden');
  }
</script>
