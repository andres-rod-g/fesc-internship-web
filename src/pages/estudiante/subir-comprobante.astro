---
import MainLayout from "~/layouts/MainLayout.astro";
import { connectDB } from "~/utils/db.js";
import { ObjectId } from "mongodb";
import { Upload, CheckCircle, AlertCircle } from "lucide-react";

const id = Astro.url.searchParams.get('id');

if (!id) {
  return Astro.redirect("/");
}

let practicante = null;
let error = null;

try {
  const db = await connectDB();
  practicante = await db.collection("practicantes").findOne({ _id: new ObjectId(id) });

  if (!practicante) {
    error = "No se encontró la preinscripción. Por favor, verifica el enlace.";
  } else if (practicante.estado_preinscripcion !== 'preinscrito') {
    error = "Esta preinscripción ya no está disponible para subir el comprobante de pago.";
  }
} catch (err) {
  console.error("Error al buscar practicante:", err);
  error = "Error al cargar la información. Por favor, intenta nuevamente.";
}
---

<MainLayout title="Subir Comprobante de Pago | FESC">
  <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-12">
    <div class="max-w-2xl mx-auto px-4">
      {error ? (
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <div class="text-center">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <AlertCircle className="w-12 h-12 text-red-600" />
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
              Error
            </h1>
            <p class="text-gray-600 mb-6">
              {error}
            </p>
            <a
              href="/"
              class="inline-flex items-center gap-2 bg-accent text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors"
            >
              Volver al Inicio
            </a>
          </div>
        </div>
      ) : practicante && (
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <div class="text-center mb-8">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Upload className="w-12 h-12 text-blue-600" />
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
              Subir Comprobante de Pago
            </h1>
            <p class="text-xl text-gray-600">
              Hola, <span class="text-accent font-semibold">{practicante.nombres} {practicante.apellidos}</span>
            </p>
          </div>

          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
            <p class="text-sm text-blue-800">
              Por favor, sube una foto clara de tu comprobante de pago de la práctica profesional. El formato debe ser JPG, PNG o PDF y no debe exceder 5MB.
            </p>
          </div>

          <form id="form-comprobante" class="space-y-6">
            <div>
              <label for="comprobante" class="block text-sm font-medium text-gray-700 mb-2">
                Comprobante de Pago *
              </label>
              <div class="flex items-center justify-center w-full">
                <label for="comprobante" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                  <div id="preview-container" class="hidden flex-col items-center justify-center pt-5 pb-6">
                    <img id="preview-image" class="max-w-full max-h-48 rounded" alt="Vista previa" />
                    <p id="file-name" class="text-sm text-gray-600 mt-2"></p>
                  </div>
                  <div id="upload-placeholder" class="flex flex-col items-center justify-center pt-5 pb-6">
                    <Upload className="w-12 h-12 text-gray-400 mb-3" />
                    <p class="mb-2 text-sm text-gray-500">
                      <span class="font-semibold">Haz clic para subir</span> o arrastra y suelta
                    </p>
                    <p class="text-xs text-gray-500">PNG, JPG o PDF (MAX. 5MB)</p>
                  </div>
                  <input
                    id="comprobante"
                    type="file"
                    accept="image/png,image/jpeg,image/jpg,application/pdf"
                    required
                    class="hidden"
                  />
                </label>
              </div>
            </div>

            <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg">
              <div class="flex items-center gap-2">
                <AlertCircle className="w-5 h-5" />
                <span id="error-text"></span>
              </div>
            </div>

            <div id="loading-message" class="hidden bg-blue-50 border border-blue-200 text-blue-600 px-4 py-3 rounded-lg">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-text">Subiendo comprobante...</span>
              </div>
            </div>

            <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg">
              <div class="flex items-center gap-2">
                <CheckCircle className="w-5 h-5" />
                <span>¡Comprobante subido exitosamente! Redirigiendo...</span>
              </div>
            </div>

            <div class="flex gap-4">
              <a
                href="/"
                class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors text-center"
              >
                Cancelar
              </a>
              <button
                type="submit"
                id="submit-btn"
                class="flex-1 bg-accent text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Subir Comprobante
              </button>
            </div>
          </form>

          <div class="mt-8 bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
            <h3 class="font-semibold text-orange-900 mb-2">⚠️ Importante</h3>
            <ul class="space-y-1 text-sm text-orange-800">
              <li>• La imagen debe ser clara y legible</li>
              <li>• El comprobante debe mostrar todos los datos de la transacción</li>
              <li>• Una vez subido, será revisado por el equipo administrativo</li>
              <li>• Recibirás una notificación cuando sea validado</li>
            </ul>
          </div>
        </div>
      )}
    </div>
  </div>
</MainLayout>

<script define:vars={{ practicanteId: id }}>
  const form = document.getElementById('form-comprobante');
  const comprobanteInput = document.getElementById('comprobante');
  const previewContainer = document.getElementById('preview-container');
  const previewImage = document.getElementById('preview-image');
  const fileName = document.getElementById('file-name');
  const uploadPlaceholder = document.getElementById('upload-placeholder');
  const errorMessage = document.getElementById('error-message');
  const errorText = document.getElementById('error-text');
  const loadingMessage = document.getElementById('loading-message');
  const loadingText = document.getElementById('loading-text');
  const successMessage = document.getElementById('success-message');
  const submitBtn = document.getElementById('submit-btn');

  // Manejar cambio de archivo
  comprobanteInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Validar tipo de archivo
      const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf'];
      if (!validTypes.includes(file.type)) {
        showError('Por favor selecciona un archivo PNG, JPG o PDF');
        comprobanteInput.value = '';
        return;
      }

      // Validar tamaño (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showError('El archivo debe ser menor a 5MB');
        comprobanteInput.value = '';
        return;
      }

      // Mostrar preview
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          fileName.textContent = file.name;
          uploadPlaceholder.classList.add('hidden');
          previewContainer.classList.remove('hidden');
          previewContainer.classList.add('flex');
        };
        reader.readAsDataURL(file);
      } else {
        // Es PDF
        fileName.textContent = file.name + ' (PDF)';
        previewImage.src = '';
        uploadPlaceholder.classList.add('hidden');
        previewContainer.classList.remove('hidden');
        previewContainer.classList.add('flex');
      }

      hideError();
    }
  });

  // Manejar envío del formulario
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = comprobanteInput.files[0];
    if (!file) {
      showError('Por favor selecciona un archivo');
      return;
    }

    // Deshabilitar botón y mostrar carga
    submitBtn.disabled = true;
    hideError();
    loadingMessage.classList.remove('hidden');

    const formData = new FormData();
    formData.append('comprobante', file);
    formData.append('practicante_id', practicanteId);

    try {
      const response = await fetch('/api/validacion-pago/subir', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        loadingMessage.classList.add('hidden');
        successMessage.classList.remove('hidden');
        form.classList.add('hidden');

        // Redirigir después de 3 segundos
        setTimeout(() => {
          window.location.href = '/preinscripcion/confirmacion-comprobante';
        }, 3000);
      } else {
        loadingMessage.classList.add('hidden');
        const data = await response.json();

        // Manejo específico de rate limit
        if (data.code === "RATE_LIMIT_EXCEEDED" || response.status === 429) {
          const details = data.details || {};
          const mensaje = `⚠️ Límite de solicitudes alcanzado\n\n${details.message || data.error}\n\nPor favor, intenta de nuevo en ${details.retryAfter || 'algunos'} segundos.`;
          showError(mensaje);
        } else {
          showError(data.error || 'Error al subir el comprobante');
        }

        submitBtn.disabled = false;
      }
    } catch (error) {
      console.error('Error:', error);
      loadingMessage.classList.add('hidden');
      showError('Error de conexión. Por favor, intenta nuevamente.');
      submitBtn.disabled = false;
    }
  });

  function showError(message) {
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
  }

  function hideError() {
    errorMessage.classList.add('hidden');
  }
</script>
